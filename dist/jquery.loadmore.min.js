/**
 * jQuery.loadMore
 * Version: 1.0.2
 * Repo: https://github.com/WahaWaher/loadmore-js
 * Author: Sergey Kravchenko
 * Contacts: wahawaher@gmail.com
 * License: MIT
 */

!function($){function randInt(t,e){var o=t-.5+Math.random()*(e-t+1);return o=Math.round(o)}var methods={init:function(options){var defaults=$.extend(!0,{url:"ajax-loadmore.php",path:"parts/",ignore:[],layout:{posts:$("<div/>"),postWrap:$("<div/>"),postImg:$("<img>").attr("alt","lm-img"),controls:$("<div/>"),button:{element:$("<button/>",{text:"Загрузить еще"}),event:"click"},preloader:{element:$('<svg width="40" height="40" viewBox="0 0 38 38" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient x1="8.042%" y1="0%" x2="65.682%" y2="23.865%" id="a"><stop stop-color="#222" stop-opacity="0" offset="0%"/><stop stop-color="#222" stop-opacity=".631" offset="63.146%"/><stop stop-color="#222" offset="100%"/></linearGradient></defs><g transform="translate(1 1)" fill="none"><path d="M36 18c0-9.94-8.06-18-18-18" stroke="#222" stroke-width="2"><animateTransform attributeName="transform" type="rotate" from="0 18 18" to="360 18 18" dur="0.9s" repeatCount="indefinite"/></path><circle fill="#222" cx="36" cy="18" r="1"><animateTransform attributeName="transform" type="rotate" from="0 18 18" to="360 18 18" dur="0.9s" repeatCount="indefinite"/></circle></g></svg>'),onInit:!1,onEachItem:!1,onButton:!1}},showFirst:3,showMore:3,firstPostDelay:0,nextPostDelay:0,beforeInit:function(){},afterInit:function(){},onInitError:function(){},beforeShowItem:function(){},afterShowItem:function(){},onShowItemError:function(){},beforeShowItems:function(){},afterShowItems:function(){}},$.fn.loadMore.defaults);return this.each(function(){var $ths=$(this);if(1==$ths.data("_init"))return!1;$ths.data("defaults",defaults),$ths.data("options",options);var data=$ths.attr("data-loadmore");"object"!=typeof(data=eval("("+data+")"))&&(data={}),$ths.data("settings",$.extend(!0,{},defaults,options,data));var sets=$ths.data("settings"),layout=sets.layout;sets.beforeInit.call($ths,sets),layout.container=$ths.addClass("loadmore"),layout.posts=layout.posts.clone().addClass("lm-posts").appendTo($ths),layout.controls=layout.controls.clone().addClass("lm-controls").appendTo($ths),layout.postWrap.addClass("lm-post-wrap"),layout.postImg.addClass("lm-post-img"),layout.preloader.element&&(layout.preloader.element=$("<div/>",{class:"lm-preloader"}).append(layout.preloader.element.clone())),layout.preloader.element&&1==layout.preloader.onInit&&layout.container.append(layout.preloader.element.clone().addClass("lm-init-preloader")),$.ajax({type:"POST",url:sets.url,data:{target:"init",get_first_posts:sets.showFirst,data:{path:sets.path,ignore:sets.ignore}},success:function(t){t=JSON.parse(t),sets.posts=t.posts,sets._itemsAll=t.all,methods.post.call($ths,sets.showFirst),layout.preloader.element&&1==layout.preloader.onInit&&$ths.find(".lm-init-preloader").remove(),layout.button.element&&(layout.button.element=layout.button.element.clone(!0).addClass("lm-btn load-more").appendTo(layout.controls)),sets._nsid=randInt(1e7,99999999),"object"==typeof layout.button.element&&layout.button.element.on(layout.button.event+".lm-"+sets._nsid,function(){return methods.post.call($ths,sets.showMore),!1}),$ths.data("_init",!0),sets.afterInit.call($ths,sets)},error:function(t){sets.onInitError.call($ths,sets,t)}})}),$(this)},post:function(t){function e(e){var r=a.firstPostDelay;$.each(e,function(e,l){var i;l.format.match(/jpg|png|jpeg/gim)&&(i="img"),l.format.match(/html|php|txt/gim)&&(i="txt");try{a.posts[l.name].content=l.content=$(l.content)}catch(t){t.message.match("unrecognized expression")&&(a.posts[l.name].content=l.content=$("<div/>",{class:"lm-post-autowrap",html:l.content}))}if("img"==i){var d=window.origin+"/"+a.path+l.name;a.posts[l.name].content=l.content=n.postImg.clone().attr("src",d)}setTimeout(function(){function e(){n.preloader.element&&1==n.preloader.onEachItem&&n.posts.find('[data-lm-postname="'+l.name+'"] .lm-post-preloader').remove(),a.beforeShowItem.call(o,a,l)}function r(){"number"!=typeof a._itemsCur&&(a._itemsCur=0),a._itemsCur+=1,a._itemsCur>=a._itemsAll&&n.button.element.remove(),a.afterShowItem.call(o,a,l),a._itemsCur>=s+t&&(n.preloader.onButton&&n.button.element.find(".lm-btn-preloader").removeClass("loading").remove(),a.afterShowItems.call(o,a))}if("txt"==i&&(e(),l.content.appendTo(n.posts.find('[data-lm-postname="'+l.name+'"]')),r()),"img"==i){var d=new Image;d.src=l.content.attr("src"),d.onload=function(){e(),l.content.appendTo(n.posts.find('[data-lm-postname="'+l.name+'"]')),r()}}},r),r+=a.nextPostDelay})}var o=$(this),a=o.data("settings"),n=a.layout,s=a._itemsCur||0;if(!a.posts||a._itemsCur==a._itemsAll&&0!=a._itemsCur)return!1;if(t||(t=a.showMore),a.beforeShowItems.call(o,a),n.button.element&&n.preloader.element&&n.preloader.onButton){var r=n.button.element,l=n.preloader.element.clone().addClass("lm-btn-preloader");0==r.find(".lm-btn-preloader").length?r.append(l.addClass("loading")):r.find(".lm-btn-preloader").addClass("loading")}var i={},d=0,p=!0;return $.each(a.posts,function(e,o){if("onpage"!=o.status){if(t<=d)return!1;"received"!=o.status&&(p=!1),i[o.name]=o;var s=n.postWrap.clone().attr("data-lm-postname",o.name);n.preloader.element&&1==n.preloader.onEachItem&&s.append(n.preloader.element.clone().addClass("lm-post-preloader")),n.posts.append(s),a.posts[o.name].status=o.status="onpage",d++}}),!1===p?$.ajax({type:"POST",url:a.url,data:{target:"get_posts_content",data:{path:a.path,ignore:a.ignore,posts:i}},success:function(t){t=JSON.parse(t),e(i=t.posts)},error:function(t){a.onShowItemError.call(o,a,t)}}):!0===p&&e(i),$(this)},destroy:function(){if(!$(this).data("_init"))return!1;var t=$(this),e=t.data("settings"),o=e.layout;return!0===t.data("_init")&&(o.button&&o.button.event&&o.button.element.off(o.button.event+".lm-"+e._nsid),t.children().remove(),t.removeData()),$(this)},reinit:function(t){var e=$(this),o=e.data("options");return methods.destroy.call(e),t&&"object"==typeof t?methods.init.call(e,t):methods.init.call(e,o),$(this)}};$.fn.loadMore=function(t){return methods[t]?methods[t].apply(this,Array.prototype.slice.call(arguments,1)):"object"!=typeof t&&t?void $.error("Method "+t+" does not exist on jQuery.loadMore"):(methods.init.apply(this,arguments),this)}}(jQuery);